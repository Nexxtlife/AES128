library ieee;
use ieee.std_logic_1164.all;

entity test_enc is
	port(
			clk_clk                                   : in  std_logic                      := 'X';             -- clk
			reset_reset_n                             : in  std_logic                      := 'X';             -- reset_n
			interface_0_avalon_master_1_read          : out std_logic;                                         -- read
			interface_0_avalon_master_1_address       : out std_logic_vector(4 downto 0);                      -- address
			interface_0_avalon_master_1_byteenable    : out std_logic_vector(15 downto 0);                     -- byteenable
			interface_0_avalon_master_1_readdata      : in  std_logic_vector(127 downto 0) := (others => 'X'); -- readdata
			
			interface_0_avalon_streaming_source_data  : out std_logic_vector(127 downto 0);                    -- data
			interface_0_avalon_streaming_source_ready : in  std_logic                      := 'X';             -- ready
			interface_0_avalon_streaming_source_valid : out std_logic                                          -- valid
	);
end test_enc;

architecture behavior of test_enc is
	component aes_enc
		port(
			clk        : in  std_logic;
			rst        : in  std_logic;
			key        : in  std_logic_vector(127 downto 0);
			plaintext  : in  std_logic_vector(127 downto 0);
			ciphertext : out std_logic_vector(127 downto 0);
			done       : out std_logic
		);		
	end component aes_enc;	
	signal clk : std_logic := '0';
	signal rst : std_logic := '0';
	signal plaintext : std_logic_vector(127 downto 0);
	signal key : std_logic_vector(127 downto 0);	
	
	signal done : std_logic;
	signal ciphertext : std_logic_vector(127 downto 0);	
	constant clk_period : time := 10 ns;
	
	enc_inst : aes_enc
				port map(
					clk        => clk,
					rst        => rst,
					key        => key,
					plaintext  => plaintext,
					ciphertext => ciphertext,
					done       => done
				);
begin
	process (clk)
	begin
	if rising_edge(clk) then
		if(reset_reset_n) then
			interface_0_avalon_streaming_source_data <= (others ='0');
			interface_0_avalon_streaming_source_ready <= '0';
			interface_0_avalon_streaming_source_valid <='0';
		elsif(interface_0_avalon_streaming_source_ready) then		
				plaintext <= x"54776F204F6E65204E696E652054776F";
				key <= x"5468617473206D79204B756E67204675";
				rst <= '0';		
				wait for clk_period * 1;
				rst <= '1';
				wait until done = '1';
				interface_0_avalon_streaming_source_data <= ciphertext;
				interface_0_avalon_streaming_source_valid <= '1';
				wait for clk_period * 1;
				interface_0_avalon_streaming_source_data <= (others=>'0');
				interface_0_avalon_streaming_source_valid <= '0';
		end if;
	end if;
	end;


	enc_inst : aes_enc
		port map(
			clk        => clk,
			rst        => rst,
			key        => key,
			plaintext  => plaintext,
			ciphertext => ciphertext,
			done       => done
		);	
	clk_process : process is
	begin
		clk <= '0';
		wait for clk_period/2;
		clk <= '1';
		wait for clk_period/2;
	end process clk_process;
	
	sim_proc : process is
	begin

		plaintext <= x"54776F204F6E65204E696E652054776F";
		key <= x"5468617473206D79204B756E67204675";
		rst <= '0';		
		wait for clk_period * 1;
		rst <= '1';
		wait until done = '1';
		wait for clk_period/2;			

		wait;
	end process sim_proc;
	
end architecture behavior;